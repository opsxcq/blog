<!doctype html><html lang=en>
<head><title>Bitcoin address generation in pure python &ndash; STRM</title>
<meta name=description content="A pro-freedom hacktivist thinktank.
">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous>
<link rel=stylesheet href=https://strm.sh/css/colour/strm-dark.css>
<link rel=stylesheet href=https://strm.sh/css/colour/dark-mode.css>
<link rel=stylesheet href=https://strm.sh/css/main.css>
<link rel=stylesheet href=https://strm.sh/css/custom.css>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
</head>
<body>
<div class=page>
<header class=page__header><h1 class=page__logo><a href=https://strm.sh class=page__logo-inner>STRM</a></h1>
<nav class="page__nav main-nav">
<ul>
<li class=main-nav__item><a class=nav-main-item href=/posts/ title>Posts</a></li>
<li class=main-nav__item><a class=nav-main-item href=/projects/ title>Projects</a></li>
<li class=main-nav__item><a class=nav-main-item href=/malware-samples/ title>Malware</a></li>
<li class=main-nav__item><a class=nav-main-item href=/studies/ title>Studies</a></li>
<li class=main-nav__item><a class=nav-main-item href=https://github.com/opsxcq/blog/discussions/3>Forum</a></li>
</ul>
</nav>
</header>
<section class=page__body>
<header class=content__header>
<h1>Bitcoin address generation in pure python</h1>
</header>
<div class=content__body>
<p>This post is dedicated to explore the generation of <code>Bitcoin</code> key pairs using pure
python with no external libraries.</p>
<p>The key pair generation can be archived in 4 steps:</p>
<ul>
<li>Generating a secure private key.</li>
<li>Calculate the public key from the private key.</li>
<li>Encode the public key as a bitcoin address.</li>
<li>Encode the private key in the WIF format.</li>
</ul>
<h2 id=step-1-generate-ecdsa-key-pair>Step 1: Generate ECDSA key pair</h2>
<p>The very first step is to select a good and secure number, for this example we
won&rsquo;t use one, instead we will simply get the random from the system. An example
why is important a good and secure random number is <a href=https://strm.sh/post/bitcoin-transaction-nonce-reuse/>written in this post about
cracking some bitcoin private keys</a>, the bug isn&rsquo;t located in the key generation,
but in the random used to sign the transactions, but the point is the same, weak
PRNG (Pseudo-random number generators) can put everything in risk.</p>
<p>Using this PRNG can be done with:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>randomBytes <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>urandom(<span style=color:#ae81ff>32</span>)
</code></pre></div><h2 id=step-2-calculate-the-public-key>Step 2: Calculate the public key</h2>
<p>Since bitcoin uses <code>spec256k</code> the only thing that we need to do is multiply it by
the initial point in the curve by the <code>private key</code> to obtain the public key.</p>
<p>Next step is to convert the key to a byte array and hash it, first with <code>SHA-256</code>
then with <code>RIPEMD-160</code>. Then we prepend the hashed public key with <code>0x00</code> if the
target network is the <strong>mainnet</strong>, if the address generated meant to be used in the
<strong>testnet</strong> <code>0x6f</code> must be prepended.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>SPEC256k1 <span style=color:#f92672>=</span> Point()
pk <span style=color:#f92672>=</span> int<span style=color:#f92672>.</span>from_bytes(privkey, <span style=color:#e6db74>&#34;big&#34;</span>)
hash160 <span style=color:#f92672>=</span> ripemd160(sha256((SPEC256k1 <span style=color:#f92672>*</span> pk)<span style=color:#f92672>.</span>toBytes()))
address <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>+</span> hash160
</code></pre></div><h3 id=checksum>Checksum</h3>
<p>Then the only thing left to add in the address it the checksum, it is appended
to the address and is the last 4 bytes of the double <code>SHA-256</code> of the address
calculated above.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>address <span style=color:#f92672>=</span> b58(address <span style=color:#f92672>+</span> sha256(sha256(address))[:<span style=color:#ae81ff>4</span>])
</code></pre></div><p>Then just encode the key bytes to <code>base58</code> and you have your Bitcoin address !</p>
<h2 id=step-3-public-key-compression>Step 3: Public key compression</h2>
<p>When representing the public key as a number is possible to compress it
considering that the key is \(x\) and \(y\) in the eliptic curve and since we have
the equation, and given an \(x\) value, there is only two values for \(y\) possible.
So to compress a public key, if \(y\) is odd, <code>0x03</code> is appended to the \(x\) value,
else, <code>0x02</code> is appended.</p>
<h2 id=step-4-encode-the-private-key-in-the-wif-format>Step 4: Encode the private key in the WIF format</h2>
<p>To create a <code>WIF</code> key representation from the private key bytes is far simple than
the previous steps, first prepend the byte <code>0x80</code> to the <code>WIF</code>, then append the
private key bytes. After, append the checksum, that is the last 4 bytes of the
double <code>SHA-256</code> of the partial wif key that we already have calculated.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>wif <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x80</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>+</span> privkey
wif <span style=color:#f92672>=</span> b58(wif <span style=color:#f92672>+</span> sha256(sha256(wif))[:<span style=color:#ae81ff>4</span>])
<span style=color:#66d9ef>return</span> wif
</code></pre></div><h2 id=source-code>Source code</h2>
<p>This is a reference script, it depends on <code>Python 3</code> to run and is self contained,
it means no external dependencies are required to run it. One example of its
output:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ ./bitcoin-address-generator.py
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>Address: 18jJh1kSPJqbXtMB51SyczgcHL1drkDgxV
Privkey: 5JTEF3GHpDAin1caVqfznHU8T1jscHVVD5SMFALBTC4no2J4DqX
</code></pre></div><h3 id=full-source-code>Full Source code</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> os
<span style=color:#f92672>import</span> hashlib


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>sha256</span>(data):
    digest <span style=color:#f92672>=</span> hashlib<span style=color:#f92672>.</span>new(<span style=color:#e6db74>&#34;sha256&#34;</span>)
    digest<span style=color:#f92672>.</span>update(data)
    <span style=color:#66d9ef>return</span> digest<span style=color:#f92672>.</span>digest()


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ripemd160</span>(x):
    d <span style=color:#f92672>=</span> hashlib<span style=color:#f92672>.</span>new(<span style=color:#e6db74>&#34;ripemd160&#34;</span>)
    d<span style=color:#f92672>.</span>update(x)
    <span style=color:#66d9ef>return</span> d<span style=color:#f92672>.</span>digest()


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>b58</span>(data):
    B58 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz&#34;</span>

    <span style=color:#66d9ef>if</span> data[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#f92672>+</span> b58(data[<span style=color:#ae81ff>1</span>:])

    x <span style=color:#f92672>=</span> sum([v <span style=color:#f92672>*</span> (<span style=color:#ae81ff>256</span> <span style=color:#f92672>**</span> i) <span style=color:#66d9ef>for</span> i, v <span style=color:#f92672>in</span> enumerate(data[::<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])])
    ret <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
    <span style=color:#66d9ef>while</span> x <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
        ret <span style=color:#f92672>=</span> B58[x <span style=color:#f92672>%</span> <span style=color:#ae81ff>58</span>] <span style=color:#f92672>+</span> ret
        x <span style=color:#f92672>=</span> x <span style=color:#f92672>//</span> <span style=color:#ae81ff>58</span>

    <span style=color:#66d9ef>return</span> ret


<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Point</span>:
    <span style=color:#66d9ef>def</span> __init__(self,
        x<span style=color:#f92672>=</span><span style=color:#ae81ff>0x79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798</span>,
        y<span style=color:#f92672>=</span><span style=color:#ae81ff>0x483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8</span>,
        p<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span><span style=color:#f92672>**</span><span style=color:#ae81ff>256</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>**</span><span style=color:#ae81ff>32</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>**</span><span style=color:#ae81ff>9</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>**</span><span style=color:#ae81ff>8</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>**</span><span style=color:#ae81ff>7</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>**</span><span style=color:#ae81ff>6</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>**</span><span style=color:#ae81ff>4</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>):
        self<span style=color:#f92672>.</span>x <span style=color:#f92672>=</span> x
        self<span style=color:#f92672>.</span>y <span style=color:#f92672>=</span> y
        self<span style=color:#f92672>.</span>p <span style=color:#f92672>=</span> p

    <span style=color:#66d9ef>def</span> __add__(self, other):
        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__radd__(other)

    <span style=color:#66d9ef>def</span> __mul__(self, other):
        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__rmul__(other)

    <span style=color:#66d9ef>def</span> __rmul__(self, other):
        n <span style=color:#f92672>=</span> self
        q <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>

        <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>256</span>):
            <span style=color:#66d9ef>if</span> other <span style=color:#f92672>&amp;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> i):
                q <span style=color:#f92672>=</span> q <span style=color:#f92672>+</span> n
            n <span style=color:#f92672>=</span> n <span style=color:#f92672>+</span> n

        <span style=color:#66d9ef>return</span> q

    <span style=color:#66d9ef>def</span> __radd__(self, other):
        <span style=color:#66d9ef>if</span> other <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
            <span style=color:#66d9ef>return</span> self
        x1 <span style=color:#f92672>=</span> other<span style=color:#f92672>.</span>x
        y1 <span style=color:#f92672>=</span> other<span style=color:#f92672>.</span>y
        x2 <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>x
        y2 <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>y
        p <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>p

        <span style=color:#66d9ef>if</span> self <span style=color:#f92672>==</span> other:
            l <span style=color:#f92672>=</span> pow(<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> y2 <span style=color:#f92672>%</span> p, p<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>, p) <span style=color:#f92672>*</span> (<span style=color:#ae81ff>3</span> <span style=color:#f92672>*</span> x2 <span style=color:#f92672>*</span> x2) <span style=color:#f92672>%</span> p
        <span style=color:#66d9ef>else</span>:
            l <span style=color:#f92672>=</span> pow(x1 <span style=color:#f92672>-</span> x2, p<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>, p) <span style=color:#f92672>*</span> (y1 <span style=color:#f92672>-</span> y2) <span style=color:#f92672>%</span> p

        newX <span style=color:#f92672>=</span> (l <span style=color:#f92672>**</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>-</span> x2 <span style=color:#f92672>-</span> x1) <span style=color:#f92672>%</span> p
        newY <span style=color:#f92672>=</span> (l <span style=color:#f92672>*</span> x2 <span style=color:#f92672>-</span> l <span style=color:#f92672>*</span> newX <span style=color:#f92672>-</span> y2) <span style=color:#f92672>%</span> p

        <span style=color:#66d9ef>return</span> Point(newX, newY)

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>toBytes</span>(self):
        x <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>x<span style=color:#f92672>.</span>to_bytes(<span style=color:#ae81ff>32</span>, <span style=color:#e6db74>&#34;big&#34;</span>)
        y <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>y<span style=color:#f92672>.</span>to_bytes(<span style=color:#ae81ff>32</span>, <span style=color:#e6db74>&#34;big&#34;</span>)
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x04</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>+</span> x <span style=color:#f92672>+</span> y


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>getPublicKey</span>(privkey):
    SPEC256k1 <span style=color:#f92672>=</span> Point()
    pk <span style=color:#f92672>=</span> int<span style=color:#f92672>.</span>from_bytes(privkey, <span style=color:#e6db74>&#34;big&#34;</span>)
    hash160 <span style=color:#f92672>=</span> ripemd160(sha256((SPEC256k1 <span style=color:#f92672>*</span> pk)<span style=color:#f92672>.</span>toBytes()))
    address <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>+</span> hash160

    address <span style=color:#f92672>=</span> b58(address <span style=color:#f92672>+</span> sha256(sha256(address))[:<span style=color:#ae81ff>4</span>])
    <span style=color:#66d9ef>return</span> address


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>getWif</span>(privkey):
    wif <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x80</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>+</span> privkey
    wif <span style=color:#f92672>=</span> b58(wif <span style=color:#f92672>+</span> sha256(sha256(wif))[:<span style=color:#ae81ff>4</span>])
    <span style=color:#66d9ef>return</span> wif


<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
    randomBytes <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>urandom(<span style=color:#ae81ff>32</span>)
    print(<span style=color:#e6db74>&#34;Address: &#34;</span> <span style=color:#f92672>+</span> getPublicKey(randomBytes))
    print(<span style=color:#e6db74>&#34;Privkey: &#34;</span> <span style=color:#f92672>+</span> getWif(randomBytes))
</code></pre></div><h2 id=references>References</h2>
<ul>
<li><a href=https://en.wikipedia.org/wiki/Elliptic-curve_cryptography>Eliptic curves in cryptography</a></li>
<li><a href=https://en.bitcoin.it/wiki/Address>Bitcoin Address documentation</a></li>
</ul>
</div>
<footer class=content__footer></footer>
<script src=https://utteranc.es/client.js repo=opsxcq/blog issue-term=title label=comment theme=dark-blue crossorigin=anonymous async></script>
</section>
<section class=page__aside>
<div class=aside__about>
<div class=aside__about>
<h1 class=about__title>## STRM ##</h1>
<p class=about__description>A pro-freedom hacktivist thinktank.</p>
</div>
<ul class=aside__social-links>
<li>
<a href=https://github.com/opsxcq/blog rel=me aria-label=GitHub title=GitHub><i class="fab fa-github" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=mailto:trash-can@strm.sh rel=me aria-label=Email title=Email><i class="fas fa-envelope" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=https://keybase.io/terminator rel=me aria-label="Keybase OPSXCQ" title="Keybase OPSXCQ"><i class="fab fa-keybase" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=https://keybase.io/team/cryptoanarquismo rel=me aria-label="Keybase Crypto" title="Keybase Crypto"><i class="fas fa-users" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=https://keybase.io/team/deepweb rel=me aria-label="Keybase Deep Web" title="Keybase Deep Web"><i class="fas fa-users" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=https://github.com/opsxcq/blog/discussions/3 rel=me aria-label=Forum title=Forum><i class="fas fa-users" aria-hidden=true></i></a>&nbsp;
</li>
</ul>
</div>
<hr>
<div class=aside__content>
<p>
By [OPSXCQ],
2018-09-14
</p>
<nav id=TableOfContents>
<ul>
<li><a href=#step-1-generate-ecdsa-key-pair>Step 1: Generate ECDSA key pair</a></li>
<li><a href=#step-2-calculate-the-public-key>Step 2: Calculate the public key</a>
<ul>
<li><a href=#checksum>Checksum</a></li>
</ul>
</li>
<li><a href=#step-3-public-key-compression>Step 3: Public key compression</a></li>
<li><a href=#step-4-encode-the-private-key-in-the-wif-format>Step 4: Encode the private key in the WIF format</a></li>
<li><a href=#source-code>Source code</a>
<ul>
<li><a href=#full-source-code>Full Source code</a></li>
</ul>
</li>
<li><a href=#references>References</a></li>
</ul>
</nav>
</div>
</section>
<footer class=page__footer><p class=copyright>STRM</p>
<p class=advertisement>Powered by <a href=https://github.com/opsxcq/blog>Open Source</a></p>
</footer>
</div>
</body>
</html>